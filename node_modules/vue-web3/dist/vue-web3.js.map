{"version":3,"file":"vue-web3.js","sources":["../src/index.js"],"sourcesContent":["module.exports = (Vue, options) => {\n\n  let web3 = options.web3\n  let callsToCheck = []\n\n  web3.eth\n    .subscribe('newBlockHeaders', err => err && console.error(err))\n    .on('data', onNewBlockHeaderData)\n\n  async function onNewBlockHeaderData(blockHeader) {\n    if (! blockHeader.number) return\n\n    // allow node some time to get the txns in the block\n    await new Promise(resolve => setTimeout(resolve, options.delay || 12000))\n\n    let block = await web3.eth.getBlock(blockHeader.number, true)\n    \n    let addressesToCheck = callsToCheck.map(call => call.contract.options.address)\n\n    let relevant = block.transactions.filter(txn => {\n      return addressesToCheck.includes(txn.to)\n    })\n\n    let addressesToCall = relevant.map(txn => txn.to)\n\n    let callsToMake = callsToCheck.filter(call => addressesToCall.includes(call.contract.options.address))\n\n    callsToMake.forEach(call => bindCall(call.vm, call.key, call))\n  }\n\n  async function bindCall(vm, key, { method, contract, args }) {\n    let call = contract.methods[method].apply(contract.methods, args)\n    let value = await call.call()\n    vm[key] = value\n    vm.$emit('CALL_SYNCED', { key, method, args, value })\n  }\n\n  Vue.prototype.$bindCall = async function (key, { method, contract, args }) {\n    callsToCheck.push({\n      vm: this,\n      key,\n      method,\n      contract,\n      args\n    })\n\n    await bindCall(this, key, { method, contract, args })\n  }\n\n  Vue.prototype.$bindEvents = async function (key, { event, contract, options }) {\n    options = Object.assign({}, { fromBlock: 0, toBlock: 'latest' }, options)\n\n    // Get previous\n    let events = await contract.getPastEvents(event, options)\n    this[key] = events\n    this.$emit('EVENTS_SYNCED', events)\n\n    // Listen for more\n    options.fromBlock = events[events.length - 1].blockNumber + 1\n    contract.events[event](options, (err, e) => {\n      if (err) throw err\n\n      this[key].push(e)\n      this.$emit('EVENT_SYNCED', e)\n    })\n  }\n\n  Vue.mixin({\n    created() {\n      var bindings = this.$options.web3\n      if (typeof bindings === 'function') bindings = bindings.call(this)\n      if (! bindings) return\n\n      Object.keys(bindings).forEach(key => {\n        if (bindings[key].method) this.$bindCall(key, bindings[key])\n        if (bindings[key].event) this.$bindEvents(key, bindings[key])\n      })      \n    }\n  })\n}\n"],"names":["module","exports","Vue","options","let","web3","callsToCheck","bindCall","vm","key","ref","method","contract","args","methods","apply","call","then","value","$await_3","$emit","eth","subscribe","err","console","error","on","blockHeader","number","Promise","resolve","setTimeout","delay","getBlock","block","$await_2","addressesToCheck","map","address","relevant","transactions","filter","txn","includes","to","addressesToCall","forEach","prototype","$bindCall","push","this","$bindEvents","event","Object","assign","fromBlock","toBlock","getPastEvents","events","$await_5","length","blockNumber","e","mixin","created","bindings","$options","keys"],"mappings":"AAAAA,OAAOC,iBAAWC,EAAKC,GAErBC,IAAIC,EAAOF,EAAQE,KACfC,KA2BJ,SAAeC,EAASC,EAAIC,EAAKC,OAAEC,WAAQC,aAAUC,SAArD,uCAEc,OADDD,EAASE,QAAQH,GAAQI,MAAMH,EAASE,QAASD,GACrCG,OAAXC,4BACZT,EAAGC,GADCS,EAAQC,EAEZX,EAAGY,MAAM,mBAAiBX,SAAKE,OAAQE,QAAMK,oCA7B/Cb,EAAKgB,IACFC,UAAU,2BAAmBC,UAAOA,GAAOC,QAAQC,MAAMF,KACzDG,GAAG,OAEN,SAAoCC,GAApC,6CACE,OAAMA,EAAYC,OAGZ,IAAIC,iBAAQC,UAAWC,WAAWD,EAAS3B,EAAQ6B,OAAS,QAAlEf,qBAEY,OAAMZ,EAAKgB,IAAIY,SAASN,EAAYC,QAAQ,GAA5CX,4BAARiB,EAAQC,EAERC,EAAmB9B,EAAa+B,aAAIrB,UAAQA,EAAKJ,SAAST,QAAQmC,UAElEC,EAAWL,EAAMM,aAAaC,gBAAOC,UAChCN,EAAiBO,SAASD,EAAIE,MAGnCC,EAAkBN,EAASF,aAAIK,UAAOA,EAAIE,KAE5BtC,EAAamC,gBAAOzB,UAAQ6B,EAAgBF,SAAS3B,EAAKJ,SAAST,QAAQmC,WAEjFQ,iBAAQ9B,UAAQT,EAASS,EAAKR,GAAIQ,EAAKP,IAAKO,qEAU1Dd,EAAI6C,UAAUC,UAAY,SAAgBvC,EAAKC,OAAEC,WAAQC,aAAUC,SAAzC,iCASxB,OARAP,EAAa2C,MACXzC,GAAI0C,SACJzC,SACAE,WACAC,OACAC,IAGIN,EAAS2C,KAAMzC,UAAOE,WAAQC,OAAUC,IAA9CI,wEAGFf,EAAI6C,UAAUI,YAAc,SAAgB1C,EAAKC,OAAE0C,UAAOxC,aAAUT,YAAxC,uCAIb,OAHbA,EAAUkD,OAAOC,WAAaC,UAAW,EAAGC,QAAS,UAAYrD,GAG9CS,EAAS6C,cAAcL,EAAOjD,GAApCc,uCACbiC,KAAKzC,GADDiD,EAASC,EAEbT,KAAK9B,MAAM,gBAAiBsC,GAG5BvD,EAAQoD,UAAYG,EAAOA,EAAOE,OAAS,GAAGC,YAAc,EAC5DjD,EAAS8C,OAAON,GAAOjD,WAAUoB,EAAKuC,GACpC,GAAIvC,EAAK,MAAMA,EAEf2B,EAAKzC,GAAKwC,KAAKa,GACfZ,EAAK9B,MAAM,eAAgB0C,4DAI/B5D,EAAI6D,OACFC,8BACMC,EAAWf,KAAKgB,SAAS7D,KACL,mBAAb4D,IAAyBA,EAAWA,EAASjD,KAAKkC,OACvDe,GAENZ,OAAOc,KAAKF,GAAUnB,iBAAQrC,GACxBwD,EAASxD,GAAKE,QAAQuC,EAAKF,UAAUvC,EAAKwD,EAASxD,IACnDwD,EAASxD,GAAK2C,OAAOF,EAAKC,YAAY1C,EAAKwD,EAASxD"}